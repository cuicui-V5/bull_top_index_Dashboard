# 牛市逃顶指数计算器 - 完整版

## 功能概述

这是一个完整的牛市逃顶指数计算器，集成了数据获取和指数计算功能。主要特点：

1. **自动化数据获取**：自动从 akshare 获取最新的市场数据
2. **多维度分析**：包含情绪、交易、趋势、估值四个维度的因子
3. **上证指数集成**：新增上证指数收盘价数据
4. **完善的错误处理**：详细的日志记录和异常处理
5. **灵活的使用方式**：支持多种运行模式

## 安装依赖

```bash
pip install pandas numpy akshare
```

## 使用方法

### 1. 完整运行（推荐）

```bash
python complete_bull_top_escape_calculator.py
```

这将：

-   自动获取所有必要的数据
-   计算逃顶指数
-   输出结果到 `逃顶指数.csv`

### 2. 使用现有数据

```bash
python complete_bull_top_escape_calculator.py --skip-fetch
```

### 3. 强制重新获取数据

```bash
python complete_bull_top_escape_calculator.py --force-refresh
```

### 4. 自定义输出文件

```bash
python complete_bull_top_escape_calculator.py --out "我的逃顶指数.csv"
```

### 5. 调整信号阈值

```bash
python complete_bull_top_escape_calculator.py --signal 80
```

## 命令行参数

| 参数              | 说明                       | 默认值         |
| ----------------- | -------------------------- | -------------- |
| `--force-refresh` | 强制重新获取数据           | False          |
| `--skip-fetch`    | 跳过数据获取，使用现有文件 | False          |
| `--out`           | 输出文件名                 | `逃顶指数.csv` |
| `--signal`        | 信号阈值                   | 75.0           |

## 数据文件说明

程序会自动生成以下数据文件：

-   `沪深300历史数据.csv` - 沪深 300 指数历史数据
-   `中证全指历史数据.csv` - 中证全指历史数据
-   `上证指数历史数据.csv` - 上证指数历史数据（新增）
-   `融资融券历史数据.csv` - 融资融券数据
-   `沪深300历史市盈率.csv` - 市盈率数据
-   `抖音搜索指数.csv` - 抖音搜索数据（需要手动提供）

## 输出文件说明

输出的 `逃顶指数.csv` 包含以下主要列：

### 基础数据

-   `日期` - 交易日期
-   `hs300_close` - 沪深 300 收盘价
-   `hs300_pe_ttm` - 沪深 300 市盈率
-   `csi_close` - 中证全指收盘价
-   `shanghai_close` - 上证指数收盘价（新增）

### 技术指标

-   `turnover_heat_z` - 成交额热度 Z 分数
-   `price_accel_z` - 价格加速度 Z 分数
-   `pe_valuation_z` - 估值 Z 分数
-   `search_heat_z` - 搜索热度 Z 分数

### 逃顶指数

-   `escape_index_0_100` - 逃顶指数（0-100）
-   `escape_signal` - 逃顶信号（0/1）
-   `escape_level` - 警戒级别（相对安全/警惕/强警戒/极度警戒）

## 警戒级别说明

| 指数范围 | 警戒级别 | 说明                   |
| -------- | -------- | ---------------------- |
| 0-59     | 相对安全 | 市场情绪相对平稳       |
| 60-74    | 警惕     | 需要关注市场变化       |
| 75-84    | 强警戒   | 市场过热，建议谨慎     |
| 85-100   | 极度警戒 | 市场极度过热，建议减仓 |

## 因子权重分配

### 维度 1: 情绪与舆情 (25%)

-   抖音搜索热度: 12.5%
-   融资融券热度: 12.5%

### 维度 2: 交易与流动性 (25%)

-   成交额热度: 12.5%
-   换手率热度: 12.5%
-   振幅热度: 10%

### 维度 3: 价格趋势与动能 (30%)

-   价格加速度: 10%
-   均线偏离度: 10%
-   上涨比例: 10%

### 维度 4: 估值 (20%)

-   市盈率估值: 20%

## 错误处理

程序包含完善的错误处理机制：

1. **数据获取失败**：会跳过该数据源，使用其他可用数据继续计算
2. **文件读取错误**：支持多种编码格式，自动尝试解析
3. **数据缺失**：使用前向填充处理缺失值
4. **详细日志**：每个步骤都有详细的日志输出

## 注意事项

1. **网络连接**：数据获取需要稳定的网络连接
2. **API 限制**：akshare 可能有调用频率限制，程序已加入延时机制
3. **数据更新**：建议定期运行以获取最新数据
4. **文件权限**：确保程序有写入文件的权限

## 示例输出

```
[2024-01-15 10:30:00] INFO: === 牛市逃顶指数计算器启动 ===
[2024-01-15 10:30:00] INFO: 步骤1: 数据获取
[2024-01-15 10:30:01] INFO: 正在获取融资融券历史数据...
[2024-01-15 10:30:05] INFO: 融资融券历史数据已保存至 融资融券历史数据.csv (共3139条记录)
[2024-01-15 10:30:08] INFO: 正在获取沪深300历史市盈率数据...
[2024-01-15 10:30:12] INFO: 沪深300历史市盈率数据已保存至 沪深300历史市盈率.csv (共4957条记录)
[2024-01-15 10:30:15] INFO: 正在获取沪深300(000300)历史行情数据...
[2024-01-15 10:30:20] INFO: 沪深300历史数据已保存至 沪深300历史数据.csv (共5021条记录)
[2024-01-15 10:30:23] INFO: 正在获取中证全指(000985)历史行情数据...
[2024-01-15 10:30:28] INFO: 中证全指历史数据已保存至 中证全指历史数据.csv (共3423条记录)
[2024-01-15 10:30:31] INFO: 正在获取上证指数(000001)历史行情数据...
[2024-01-15 10:30:36] INFO: 上证指数历史数据已保存至 上证指数历史数据.csv (共5021条记录)
[2024-01-15 10:30:36] INFO: 数据获取完成，成功获取 5/5 个数据源
[2024-01-15 10:30:36] INFO: 步骤2: 数据加载和合并
[2024-01-15 10:30:36] INFO: 加载沪深300数据: 沪深300历史数据.csv
[2024-01-15 10:30:37] INFO: 沪深300数据加载完成，共5021条记录
[2024-01-15 10:30:37] INFO: 加载中证全指数据: 中证全指历史数据.csv
[2024-01-15 10:30:38] INFO: 中证全指数据加载完成，共3423条记录
[2024-01-15 10:30:38] INFO: 加载上证指数数据: 上证指数历史数据.csv
[2024-01-15 10:30:39] INFO: 上证指数数据加载完成，共5021条记录
[2024-01-15 10:30:39] INFO: 加载融资融券数据: 融资融券历史数据.csv
[2024-01-15 10:30:40] INFO: 融资融券数据加载完成，共3139条记录
[2024-01-15 10:30:40] INFO: 加载市盈率数据: 沪深300历史市盈率.csv
[2024-01-15 10:30:41] INFO: 市盈率数据加载完成，共4957条记录
[2024-01-15 10:30:41] INFO: margin数据合并成功
[2024-01-15 10:30:41] INFO: pe数据合并成功
[2024-01-15 10:30:41] INFO: 数据合并完成，共5021条记录
[2024-01-15 10:30:41] INFO: 步骤3: 特征工程
[2024-01-15 10:30:41] INFO: 开始特征工程...
[2024-01-15 10:30:45] INFO: 特征工程完成
[2024-01-15 10:30:45] INFO: 步骤4: 计算逃顶指数
[2024-01-15 10:30:45] INFO: 开始计算逃顶指数...
[2024-01-15 10:30:46] INFO: 逃顶指数计算完成
[2024-01-15 10:30:46] INFO: 步骤5: 输出结果
[2024-01-15 10:30:47] INFO: 逃顶指数已输出到: 逃顶指数.csv
[2024-01-15 10:30:47] INFO: 最新日期: 2024-01-15
[2024-01-15 10:30:47] INFO: 最新逃顶指数: 45.23
[2024-01-15 10:30:47] INFO: 警戒级别: 相对安全
[2024-01-15 10:30:47] INFO: === 计算完成 ===
```

## 技术支持

如有问题，请检查：

1. 网络连接是否正常
2. 是否安装了所有依赖包
3. 文件权限是否正确
4. 查看详细的错误日志信息
