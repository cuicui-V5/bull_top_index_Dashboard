<!DOCTYPE html>
<html lang="zh">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0"
        />
        <title>牛市逃顶指数仪表盘</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4"></script>
        <script src="https://cdn.jsdelivr.net/npm/luxon@3.5.0"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                    Roboto, Helvetica, Arial, sans-serif;
                background-color: #f5f5f7;
                color: #1d1d1f;
                margin: 0;
                padding: 0;
                display: flex;
                flex-direction: column;
                align-items: center;
                min-height: 100vh;
                overflow-x: hidden;
            }
            header {
                width: 100%;
                max-width: 1200px;
                padding: 20px;
                text-align: center;
            }
            h1 {
                font-size: 32px;
                font-weight: 600;
                margin: 0;
            }
            .dashboard {
                width: 100%;
                max-width: 1200px;
                padding: 20px;
                display: flex;
                flex-direction: column;
                gap: 20px;
            }
            .latest-index {
                background-color: #ffffff;
                border-radius: 18px;
                padding: 24px;
                text-align: center;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }
            .index-value {
                font-size: 48px;
                font-weight: 700;
                color: #007aff;
            }
            .risk-level {
                font-size: 24px;
                font-weight: 500;
                margin-top: 8px;
            }
            .controls {
                display: flex;
                justify-content: space-between;
                gap: 16px;
                flex-wrap: wrap;
            }
            .control-group {
                display: flex;
                gap: 8px;
                background-color: #ffffff;
                border-radius: 12px;
                padding: 8px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            }
            button {
                background-color: #f5f5f7;
                border: none;
                border-radius: 8px;
                padding: 8px 16px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: background-color 0.2s;
            }
            button:hover {
                background-color: #e5e5e7;
            }
            button.active {
                background-color: #007aff;
                color: #ffffff;
            }
            .date-picker {
                display: flex;
                gap: 8px;
                align-items: center;
            }
            input[type="date"] {
                border: none;
                background-color: #f5f5f7;
                border-radius: 8px;
                padding: 8px 12px;
                font-size: 14px;
            }
            .chart-container {
                background-color: #ffffff;
                border-radius: 18px;
                padding: 24px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                position: relative;
                height: 500px;
            }
            .overlay-selector {
                position: absolute;
                top: 24px;
                right: 24px;
                z-index: 10;
            }
            .overlay-button {
                background-color: #007aff;
                color: #ffffff;
                border-radius: 8px;
                padding: 8px 16px;
            }
            .overlay-menu {
                display: none;
                position: absolute;
                right: 0;
                background-color: #ffffff;
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                padding: 8px;
                width: 200px;
            }
            .overlay-menu label {
                display: block;
                padding: 8px;
                font-size: 14px;
            }
            .overlay-menu.show {
                display: block;
            }
            canvas {
                transition: all 0.3s ease;
            }
            footer {
                width: 100%;
                max-width: 1200px;
                padding: 20px;
                text-align: center;
            }
        </style>
    </head>
    <body>
        <header>
            <h1>牛市逃顶指数仪表盘</h1>
        </header>
        <div class="dashboard">
            <div class="latest-index">
                <div
                    class="index-value"
                    id="latest-index"
                >
                    加载中...
                </div>
                <div
                    class="risk-level"
                    id="risk-level"
                >
                    加载中...
                </div>
            </div>
            <div class="controls">
                <div
                    class="control-group"
                    id="period-buttons"
                >
                    <button
                        data-period="30d"
                        class="active"
                    >
                        30天
                    </button>
                    <button data-period="3m">3个月</button>
                    <button data-period="6m">6个月</button>
                    <button data-period="1y">1年</button>
                    <button data-period="3y">3年</button>
                    <button data-period="5y">5年</button>
                    <button data-period="10y">10年</button>
                    <button data-period="all">全部</button>
                </div>
                <div
                    class="control-group"
                    id="view-buttons"
                >
                    <button
                        data-view="day"
                        class="active"
                    >
                        日
                    </button>
                    <button data-view="week">周</button>
                    <button data-view="month">月</button>
                    <button data-view="year">年</button>
                </div>
                <div class="date-picker">
                    <label>从</label>
                    <input
                        type="date"
                        id="start-date"
                    />
                    <label>到</label>
                    <input
                        type="date"
                        id="end-date"
                    />
                    <button id="apply-date">应用</button>
                </div>
            </div>
            <div class="chart-container">
                <div class="overlay-selector">
                    <button
                        class="overlay-button"
                        id="overlay-toggle"
                    >
                        叠加指标
                    </button>
                    <div
                        class="overlay-menu"
                        id="overlay-menu"
                    >
                        <label>
                            <input
                                type="checkbox"
                                data-indicator="hs300_close"
                            />
                            沪深300收盘价
                        </label>
                        <label>
                            <input
                                type="checkbox"
                                data-indicator="hs300_ret"
                            />
                            沪深300收益率
                        </label>
                        <label>
                            <input
                                type="checkbox"
                                data-indicator="hs300_turnover_log"
                            />
                            沪深300交易额 (log)
                        </label>
                        <label>
                            <input
                                type="checkbox"
                                data-indicator="hs300_amplitude"
                            />
                            沪深300振幅
                        </label>
                        <label>
                            <input
                                type="checkbox"
                                data-indicator="hs300_turnover_rate"
                            />
                            沪深300换手率
                        </label>
                        <label>
                            <input
                                type="checkbox"
                                data-indicator="csi_close"
                            />
                            中证全指收盘价
                        </label>
                        <label>
                            <input
                                type="checkbox"
                                data-indicator="csi_ret"
                            />
                            中证全指收益率
                        </label>
                        <label>
                            <input
                                type="checkbox"
                                data-indicator="csi_turnover_log"
                            />
                            中证全指交易额 (log)
                        </label>
                        <label>
                            <input
                                type="checkbox"
                                data-indicator="csi_amplitude"
                            />
                            中证全指振幅
                        </label>
                        <label>
                            <input
                                type="checkbox"
                                data-indicator="margin_total"
                            />
                            融资余额
                        </label>
                        <label>
                            <input
                                type="checkbox"
                                data-indicator="douyin_search"
                            />
                            抖音搜索指数
                        </label>
                    </div>
                </div>
                <canvas id="escape-chart"></canvas>
            </div>
        </div>
        <footer>本网站数据仅供参考 不构成投资建议</footer>
        <script>
            let chart;
            let rawData = [];
            let filteredData = [];
            let currentView = "day";
            let overlays = {};

            // 获取数据
            async function fetchData() {
                try {
                    const response = await fetch(
                        "https://chuanjiabao.cuijunyu.win:3001/api/data",
                    );
                    const json = await response.json();
                    rawData = json.data
                        .map(item => ({
                            date: new Date(item["﻿日期"]),
                            escape_index: parseFloat(item.escape_index_0_100),
                            escape_level: item.escape_level,
                            hs300_close: parseFloat(item.hs300_close) || null,
                            hs300_ret: parseFloat(item.hs300_ret) || null,
                            hs300_turnover_log:
                                parseFloat(item.hs300_turnover_log) || null,
                            hs300_amplitude:
                                parseFloat(item.hs300_amplitude) || null,
                            hs300_turnover_rate:
                                parseFloat(item.hs300_turnover_rate) || null,
                            csi_close: parseFloat(item.csi_close) || null,
                            csi_ret: parseFloat(item.csi_ret) || null,
                            csi_turnover_log:
                                parseFloat(item.csi_turnover_log) || null,
                            csi_amplitude:
                                parseFloat(item.csi_amplitude) || null,
                            margin_total: parseFloat(item.margin_total) || null,
                            douyin_search:
                                parseFloat(item.douyin_search) || null,
                        }))
                        .sort((a, b) => a.date - b.date);

                    const latest = rawData[rawData.length - 1];
                    document.getElementById("latest-index").textContent =
                        latest.escape_index.toFixed(1);
                    document.getElementById("risk-level").textContent =
                        latest.escape_level;

                    const minDate = rawData[0].date.toISOString().split("T")[0];
                    const maxDate = latest.date.toISOString().split("T")[0];
                    document.getElementById("start-date").value = minDate;
                    document.getElementById("end-date").value = maxDate;
                    document.getElementById("start-date").min = minDate;
                    document.getElementById("start-date").max = maxDate;
                    document.getElementById("end-date").min = minDate;
                    document.getElementById("end-date").max = maxDate;

                    updatePeriod("30d");
                } catch (error) {
                    console.error("数据获取失败:", error);
                }
            }

            // 聚合数据
            function aggregateData(data, view) {
                if (view === "day") return data;

                const aggregated = {};
                data.forEach(item => {
                    let key;
                    const dt = luxon.DateTime.fromJSDate(item.date);
                    if (view === "week") {
                        key = dt.startOf("week").toISODate();
                    } else if (view === "month") {
                        key = dt.startOf("month").toISODate();
                    } else if (view === "year") {
                        key = dt.startOf("year").toISODate();
                    }
                    if (!aggregated[key]) {
                        aggregated[key] = {
                            date: new Date(key),
                            count: 0,
                            sum_escape: 0,
                            averages: {},
                        };
                    }
                    aggregated[key].count++;
                    aggregated[key].sum_escape += item.escape_index;
                    Object.keys(overlays).forEach(ind => {
                        if (!aggregated[key].averages[ind])
                            aggregated[key].averages[ind] = {
                                sum: 0,
                                count: 0,
                            };
                        if (item[ind] !== null) {
                            aggregated[key].averages[ind].sum += item[ind];
                            aggregated[key].averages[ind].count++;
                        }
                    });
                });

                return Object.values(aggregated)
                    .map(agg => ({
                        date: agg.date,
                        escape_index: agg.sum_escape / agg.count,
                        ...Object.fromEntries(
                            Object.entries(agg.averages).map(([ind, val]) => [
                                ind,
                                val.count > 0 ? val.sum / val.count : null,
                            ]),
                        ),
                    }))
                    .sort((a, b) => a.date - b.date);
            }

            // 归一化数据到0-100
            function normalizeData(data, key) {
                const values = data.map(d => d[key]).filter(v => v !== null);
                if (values.length === 0)
                    return data.map(d => ({ x: d.date, y: null }));
                const min = Math.min(...values);
                const max = Math.max(...values);
                const range = max - min || 1; // 防止除以0
                return data.map(d => ({
                    x: d.date,
                    y: d[key] !== null ? ((d[key] - min) / range) * 100 : null,
                }));
            }

            // 更新图表
            function updateChart() {
                const aggregatedData = aggregateData(filteredData, currentView);

                const datasets = [
                    {
                        label: "逃顶指数 (0-100)",
                        data: aggregatedData.map(d => ({
                            x: d.date,
                            y: d.escape_index,
                        })),
                        borderColor: "#007aff",
                        backgroundColor: "rgba(0, 122, 255, 0.1)",
                        fill: true,
                        tension: 0.4,
                        yAxisID: "y",
                    },
                ];

                // 添加归一化的叠加数据集
                Object.keys(overlays).forEach(ind => {
                    if (overlays[ind]) {
                        datasets.push({
                            label: {
                                hs300_close: "沪深300收盘价",
                                hs300_ret: "沪深300收益率",
                                hs300_turnover_log: "沪深300交易额 (log)",
                                hs300_amplitude: "沪深300振幅",
                                hs300_turnover_rate: "沪深300换手率",
                                csi_close: "中证全指收盘价",
                                csi_ret: "中证全指收益率",
                                csi_turnover_log: "中证全指交易额 (log)",
                                csi_amplitude: "中证全指振幅",
                                margin_total: "融资余额",
                                douyin_search: "抖音搜索指数",
                            }[ind],
                            data: normalizeData(aggregatedData, ind),
                            borderColor: getColorForIndicator(ind),
                            yAxisID: "y1",
                            tension: 0.4,
                        });
                    }
                });

                if (chart) chart.destroy();
                chart = new Chart(document.getElementById("escape-chart"), {
                    type: "line",
                    data: { datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: "index", intersect: false },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: ctx =>
                                        `${
                                            ctx.dataset.label
                                        }: ${ctx.parsed.y.toFixed(2)}`,
                                    title: ctx => {
                                        const date = new Date(ctx[0].parsed.x);
                                        return date.toLocaleDateString(
                                            "zh-CN",
                                            {
                                                year: "numeric",
                                                month: "2-digit",
                                                day: "2-digit",
                                            },
                                        );
                                    },
                                },
                                backgroundColor: "#ffffff",
                                titleColor: "#1d1d1f",
                                bodyColor: "#1d1d1f",
                                borderColor: "#e5e5e7",
                                borderWidth: 1,
                                cornerRadius: 8,
                            },
                            zoom: {
                                zoom: {
                                    wheel: { enabled: true },
                                    pinch: { enabled: true },
                                    mode: "x",
                                },
                                pan: { enabled: true, mode: "x" },
                            },
                        },
                        scales: {
                            x: {
                                type: "time",
                                time: {
                                    unit:
                                        currentView === "year"
                                            ? "year"
                                            : currentView === "month"
                                            ? "month"
                                            : currentView === "week"
                                            ? "week"
                                            : "day",
                                },
                                adapters: { date: { library: luxon } },
                                title: { display: true, text: "日期" },
                            },
                            y: {
                                type: "linear",
                                position: "left",
                                title: { display: true, text: "逃顶指数" },
                                min: 0,
                                max: 100,
                            },
                            y1: {
                                type: "linear",
                                position: "right",
                                title: {
                                    display: true,
                                    text: "叠加指标 (归一化)",
                                },
                                min: 0,
                                max: 100,
                                grid: { drawOnChartArea: false },
                            },
                        },
                        elements: {
                            point: {
                                radius: aggregatedData.length > 100 ? 0 : 3,
                            },
                        },
                        animation: { duration: 300 },
                    },
                });
            }

            // 获取指标颜色
            function getColorForIndicator(ind) {
                const colors = {
                    hs300_close: "#ff9500",
                    hs300_ret: "#ffcc00",
                    hs300_turnover_log: "#ff2d55",
                    hs300_amplitude: "#5856d6",
                    hs300_turnover_rate: "#af52de",
                    csi_close: "#34c759",
                    csi_ret: "#00c7be",
                    csi_turnover_log: "#ff3b30",
                    csi_amplitude: "#5ac8fa",
                    margin_total: "#007aff",
                    douyin_search: "#ff9500",
                };
                return colors[ind] || "#000000";
            }

            // 更新时间段
            function updatePeriod(period) {
                const latestDate = rawData[rawData.length - 1].date;
                let startDate;
                switch (period) {
                    case "30d":
                        startDate = new Date(latestDate);
                        startDate.setDate(startDate.getDate() - 30);
                        break;
                    case "3m":
                        startDate = new Date(latestDate);
                        startDate.setMonth(startDate.getMonth() - 3);
                        break;
                    case "6m":
                        startDate = new Date(latestDate);
                        startDate.setMonth(startDate.getMonth() - 6);
                        break;
                    case "1y":
                        startDate = new Date(latestDate);
                        startDate.setFullYear(startDate.getFullYear() - 1);
                        break;
                    case "3y":
                        startDate = new Date(latestDate);
                        startDate.setFullYear(startDate.getFullYear() - 3);
                        break;
                    case "5y":
                        startDate = new Date(latestDate);
                        startDate.setFullYear(startDate.getFullYear() - 5);
                        break;
                    case "10y":
                        startDate = new Date(latestDate);
                        startDate.setFullYear(startDate.getFullYear() - 10);
                        break;
                    case "all":
                        startDate = rawData[0].date;
                        break;
                }
                filteredData = rawData.filter(d => d.date >= startDate);
                document.getElementById("start-date").value = startDate
                    .toISOString()
                    .split("T")[0];
                updateChart();
            }

            // 事件监听
            document
                .getElementById("period-buttons")
                .addEventListener("click", e => {
                    if (e.target.tagName === "BUTTON") {
                        [...e.target.parentNode.children].forEach(btn =>
                            btn.classList.remove("active"),
                        );
                        e.target.classList.add("active");
                        updatePeriod(e.target.dataset.period);
                    }
                });

            document
                .getElementById("view-buttons")
                .addEventListener("click", e => {
                    if (e.target.tagName === "BUTTON") {
                        [...e.target.parentNode.children].forEach(btn =>
                            btn.classList.remove("active"),
                        );
                        e.target.classList.add("active");
                        currentView = e.target.dataset.view;
                        updateChart();
                    }
                });

            document
                .getElementById("apply-date")
                .addEventListener("click", () => {
                    const start = new Date(
                        document.getElementById("start-date").value,
                    );
                    const end = new Date(
                        document.getElementById("end-date").value,
                    );
                    filteredData = rawData.filter(
                        d => d.date >= start && d.date <= end,
                    );
                    updateChart();
                });

            document
                .getElementById("overlay-toggle")
                .addEventListener("click", () => {
                    document
                        .getElementById("overlay-menu")
                        .classList.toggle("show");
                });

            document
                .getElementById("overlay-menu")
                .addEventListener("change", e => {
                    const ind = e.target.dataset.indicator;
                    overlays[ind] = e.target.checked;
                    updateChart();
                });

            // 初始化
            fetchData();
        </script>
    </body>
    <script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
            return cell !== "" && cell != null;
        }
        function loadFileData(filename) {
            if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
                try {
                    var workbook = XLSX.read(gk_fileData[filename], {
                        type: "base64",
                    });
                    var firstSheetName = workbook.SheetNames[0];
                    var worksheet = workbook.Sheets[firstSheetName];

                    // Convert sheet to JSON to filter blank rows
                    var jsonData = XLSX.utils.sheet_to_json(worksheet, {
                        header: 1,
                        blankrows: false,
                        defval: "",
                    });
                    // Filter out blank rows (rows where all cells are empty, null, or undefined)
                    var filteredData = jsonData.filter(row =>
                        row.some(filledCell),
                    );

                    // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                    var headerRowIndex = filteredData.findIndex(
                        (row, index) =>
                            row.filter(filledCell).length >=
                            filteredData[index + 1]?.filter(filledCell).length,
                    );
                    // Fallback
                    if (headerRowIndex === -1 || headerRowIndex > 25) {
                        headerRowIndex = 0;
                    }

                    // Convert filtered JSON back to CSV
                    var csv = XLSX.utils.aoa_to_sheet(
                        filteredData.slice(headerRowIndex),
                    ); // Create a new sheet from filtered array of arrays
                    csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                    return csv;
                } catch (e) {
                    console.error(e);
                    return "";
                }
            }
            return gk_fileData[filename] || "";
        }
    </script>
</html>
